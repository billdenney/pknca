---
title: "Methods Used for Dose-Aware Concentration Interpolation/Extrapolation"
author: "William Denney"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Methods Used for Dose-Aware Concentration Interpolation/Extrapolation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(PKNCA)
library(dplyr)
```

# Introduction

Interpolation and extrapolation with awareness of doses occurring before, at the same time of, or after the requested interpolation time point must account for many interactions.  To ensure clarity in the interpolation/extrapolation methods and the decisions made by the algorithm, each potential choice is listed below with its accompanying calculation method.  The code used to generate the table is the same as the code within the function.

```{r generatecombs, echo=FALSE}
event.before <-
  data.frame(event.before=c(NA, "conc", "dose", "dose", "both", "both"),
             iv.bolus.before=c(NA, NA, FALSE, TRUE, FALSE, TRUE))
event.at <-
  data.frame(event.at=c(NA, "conc", "dose", "dose", "both", "both"),
             iv.bolus.at=c(NA, NA, FALSE, TRUE, FALSE, TRUE))
event.after <-
  data.frame(event.after=c(NA, "conc", "dose", "both"))
time.request <-
  data.frame(after=c(FALSE, TRUE))

method.choices <- names(PKNCA:::interp.extrap.conc.dose.select)
method.choices <-
  factor(method.choices, levels=method.choices, ordered=TRUE)
         
all.combs <-
  merge(
    merge(
      merge(event.before, event.at),
      event.after),
    time.request)
all.combs$Method <- ""

for (n in method.choices) {
  mask <-
    PKNCA:::interp.extrap.conc.dose.select[[n]]$select(all.combs)
  mask.overlap <- mask &
    !(all.combs$Method %in% "")
  all.combs$Method[mask & ! mask.overlap] <- n
  #all.combs$Method[mask.overlap] <- paste(all.combs$Method[mask.overlap], n, sep="; ")
  #cat(n, sum(mask), "\n")
}

all.combs <-
  all.combs[do.call(order,
                    args=append(as.list(all.combs), list(na.last=FALSE))),]
```

# Methods

The method list below is described and sorted in order of how many scenarios the method is applied to in the list.

For each of the summary tables below, the column headers are as follows:

* **Event Before**: The type of event immediately before the time of the requested output may be one of the following:
    * *NA*: No event
    * *dose*: A dosing event without a simultaneous concentration measure
    * *conc*: A concentration measurement without a simultaneous dose
    * *both*: A dosing event at the same time as a concentration measurement
* **IV Bolus Before**:  If the "Event Before" the requested output time was a "dose" or "both", was the dose an IV bolus?
    * *TRUE*: Yes, it was an IV bolus.
    * *FALSE*: No, it was not an IV bolus.
    * *NA*: It was not a dose.
* **Event At**: The equivalent to "Event Before" but for the event occurring at the requested output time.
* **IV Bolus At**:  The equivalent to "IV Bolus Before" but for the event occurring at the requested output time.
* **Event After**: The equivalent to "Event Before" but for the next event occurring after the requested output time.
* **Instant After**:  Should the time of the output be considered instantaneously after the requested output time?  "After" only has an effect relative to an IV bolus.
    * *TRUE*: Yes, the output is immediately after.
    * *FALSE*: No, the output is immediately before.

```{r methodsummary, results="asis", echo=FALSE}
methodorder <- names(sort(summary(factor(all.combs$Method)), decreasing=TRUE))

for (n in methodorder) {
  cat("## ", n, "\n\n", sep="")
  cat(PKNCA:::interp.extrap.conc.dose.select[[n]]$description, "\n\n", sep="")
  print(knitr::kable(
    all.combs[all.combs$Method %in% n,
              c("event.before", "iv.bolus.before",
                "event.at", "iv.bolus.at", "event.after",
                "after")],
    row.names=FALSE,
    col.names=c("Event Before", "IV Bolus Before", "Event At", "IV Bolus At", "Event After", "Instant After")))
  cat("\n")
}
```

# Appendix: Complete Methods Table

```{r methodlisting, echo=FALSE}
knitr::kable(
  all.combs[,c("event.before", "iv.bolus.before",
               "event.at", "iv.bolus.at", "event.after",
               "after", "Method")],
    row.names=FALSE,
    col.names=c("Event Before", "IV Bolus Before",
                "Event At", "IV Bolus At", "Event After",
                "Instant After", "Method Used"))
```
