<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Writing PKNCA Parameter Functions • PKNCA</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Writing PKNCA Parameter Functions">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">PKNCA</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.11.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/v01-introduction-and-usage.html">Introduction to PKNCA and Usage Instructions</a></li>
    <li><a class="dropdown-item" href="../articles/v02-example-theophylline.html">Computing NCA Parameters for Theophylline</a></li>
    <li><a class="dropdown-item" href="../articles/v03-selection-of-calculation-intervals.html">Selection of Calculation Intervals</a></li>
    <li><a class="dropdown-item" href="../articles/v04-sparse.html">Sparse NCA Calculations</a></li>
    <li><a class="dropdown-item" href="../articles/v05-auc-calculation-with-PKNCA.html">AUC Calculation with PKNCA</a></li>
    <li><a class="dropdown-item" href="../articles/v06-half-life-calculation-tobit.html">Half-life calculation with Tobit regression</a></li>
    <li><a class="dropdown-item" href="../articles/v06-half-life-calculation.html">Half-Life Calculation</a></li>
    <li><a class="dropdown-item" href="../articles/v07-post-processing.html">Post-Processing</a></li>
    <li><a class="dropdown-item" href="../articles/v07-unit-conversion.html">Unit Assignment and Conversion with PKNCA</a></li>
    <li><a class="dropdown-item" href="../articles/v08-data-imputation.html">Data Imputation</a></li>
    <li><a class="dropdown-item" href="../articles/v20-superposition.html">Superposition of Pharmacokinetic Data</a></li>
    <li><a class="dropdown-item" href="../articles/v21-methods-for-dose-aware-interpolation-and-extrapolation.html">Methods Used for Dose-Aware Concentration Interpolation/Extrapolation</a></li>
    <li><a class="dropdown-item" href="../articles/v22-time-to-steady-state.html">Noncompartmental evaluation of time to steady-state</a></li>
    <li><a class="dropdown-item" href="../articles/v23-auc-integration-methods.html">AUC integration methods</a></li>
    <li><a class="dropdown-item" href="../articles/v30-training-session.html">PKNCA Training Sessions</a></li>
    <li><a class="dropdown-item" href="../articles/v40-options-for-controlling-PKNCA.html">Options for Controlling PKNCA</a></li>
    <li><a class="dropdown-item" href="../articles/v60-PKNCA-validation.html">PKNCA Validation</a></li>
    <li><a class="dropdown-item" href="../articles/v80-writing-parameter-functions.html">Writing PKNCA Parameter Functions</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/billdenney/pknca/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Writing PKNCA Parameter Functions</h1>
                        <h4 data-toc-skip class="author">Bill
Denney</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/billdenney/pknca/blob/main/vignettes/v80-writing-parameter-functions.Rmd" class="external-link"><code>vignettes/v80-writing-parameter-functions.Rmd</code></a></small>
      <div class="d-none name"><code>v80-writing-parameter-functions.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="writing-pknca-parameter-functions">Writing PKNCA Parameter Functions<a class="anchor" aria-label="anchor" href="#writing-pknca-parameter-functions"></a>
</h2>
<p>The PKNCA package is designed to be comprehensive in its coverage of
the needs of an noncompartmental analysis (NCA) specialist. While it has
many NCA parameters specified, it may not have all parameters defined,
and its design is modular to accept new parameter definitions. From its
inception, PKNCA is built in modules to allow addition of new components
(or removal of unnecessary ones). Defining new NCA parameters is
straight-forward, and this guide will describe how it is done. The three
parts to writing a new NCA parameter in PKNCA are described below.</p>
</div>
<div class="section level2">
<h2 id="writing-the-parameter-function">Writing the Parameter Function<a class="anchor" aria-label="anchor" href="#writing-the-parameter-function"></a>
</h2>
<div class="section level3">
<h3 id="requirements">Requirements<a class="anchor" aria-label="anchor" href="#requirements"></a>
</h3>
<p>The starting point to writing a new NCA parameter is writing the
function that calculates the parameter value. The function can be passed
any of the following arguments. The arguments must be named as described
below:</p>
<ul>
<li>
<code>conc</code> is the numeric vector of plasma concentrations for
an interval for a single group (usually a single analyte for a single
subject in a single study).</li>
<li>
<code>time</code> is the numeric vector of the time for plasma
concentration measurements.</li>
<li>
<code>duration.conc</code> is the duration of a concentration
measurement (usually for urine or fecal measurements)</li>
<li>
<code>dose</code> is the numeric vector of dose amounts for an
interval for a single group. NOTE: This is a vector and not always a
scalar. If your function expects a scalar, you should usually take the
sum of the dose argument.</li>
<li>
<code>time.dose</code> is the numeric vector of time for the
doses.</li>
<li>
<code>duration.dose</code> is the duration of a dose (usually for
intravenous infusions)</li>
<li>
<code>start</code> and <code>end</code> are the scalar numbers for
the start and end time of the current interval. NOTE: <code>end</code>
may be <code>Inf</code> (infinity).</li>
<li>
<code>options</code> are the PKNCA options used for the current
calculation usually as defined by the <code>PKNCA.option</code> function
(though these options may be over-ridden by the <code>options</code>
argument to the <code>PKNCAdata</code> function.</li>
<li>Or, any NCA parameters by name (as given by
<code>names(get.interval.cols())</code>).</li>
</ul>
<p>The function should return either a scalar which is the value for the
parameter (usually the case) or a data.frame with parameters named for
each parameter calculated. For an example of returning a data.frame, see
the <code>half.life</code> function.</p>
<p>The return value may have an attribute of <code>exclude</code> (set
by <code>attr(return_value, "exclude") &lt;- "reason"</code>). If the
<code>exclude</code> attribute is set to a character string, then that
string will be included in the <code>exclude</code> column for results.
If any of the input parameters have an exclude attribute set, then those
are also added to the <code>exclude</code> column. The exception to the
setting of the <code>exclude</code> column is if the
<code>exclude</code> attribute is <code>"DO NOT EXCLUDE"</code>, then
the <code>exclude</code> column is set to
<code>NA_character_</code>.</p>
</div>
<div class="section level3">
<h3 id="best-practices">Best Practices<a class="anchor" aria-label="anchor" href="#best-practices"></a>
</h3>
<ul>
<li>Use the function <code>assert_conc_time</code> if the function takes
either <code>conc</code> or <code>time</code> as an input.</li>
<li>Make sure that you check for missing values (<code>NA</code>) in
your inputs.</li>
<li>Don’t recalculate other NCA parameters within your function unless
you absolutely must. Take the NCA parameter as an input. That way, PKNCA
will track the calculation dependencies.</li>
<li>For consistency with the rest of PKNCA, start the function name with
“pk.calc” (like “pk.calc.cmax”).</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="tell-pknca-about-the-parameter">Tell PKNCA about the Parameter<a class="anchor" aria-label="anchor" href="#tell-pknca-about-the-parameter"></a>
</h2>
<p>Just writing a function doesn’t connect it to the rest of PKNCA. You
have to tell PKNCA that the function exists and a few more details about
it. To do this, you need to use the <code>add.interval.col</code>
function. The function takes up to seven arguments:</p>
<ul>
<li>
<code>name</code> is the name of the parameter (as a character
string).</li>
<li>
<code>FUN</code> is the function name (as a character string).</li>
<li>
<code>values</code> are the possible values for the interval column
(currently only <code>TRUE</code> and <code>FALSE</code> are
supported).</li>
<li>
<code>depends</code> is a character vector of columns that must
exist before this column can be created. Use this to tell PKNCA about
calculation dependencies (parameter X must be calculated to be able to
calculate parameter Y).</li>
<li>
<code>formalsmap</code> remaps the (formal) function arguments.
<code>formalsmap</code> is usually used when the same function may be
used for multiple different parameters, for example the function
<code>pk.calc.thalf.eff</code> is used to calculate the parameters
<code>thalf.eff.obs</code>, <code>thalf.eff.pred</code>,
<code>thalf.eff.last</code>, <code>thalf.eff.iv.obs</code>,
<code>thalf.eff.iv.pred</code>, and <code>thalf.eff.iv.last</code> with
different mean residence time inputs.</li>
<li>
<code>desc</code> is a text description of the parameter.</li>
</ul>
</div>
<div class="section level2">
<h2 id="tell-pknca-how-to-summarize-the-parameter">Tell PKNCA How to Summarize the Parameter<a class="anchor" aria-label="anchor" href="#tell-pknca-how-to-summarize-the-parameter"></a>
</h2>
<p>For any parameter, PKNCA needs to know how to summarize it for the
<code>summary</code> function of the <code>PKNCAresults</code> class. To
tell PKNCA how to summarize a parameter, use the
<code>PKNCA.set.summary</code> function. It takes at least these four
arguments:</p>
<ul>
<li>
<code>name</code> must match an already existing parameter name
(added by the <code>add.interval.col</code> function).</li>
<li>
<code>description</code> is a human-readable description of the
<code>point</code> and <code>spread</code> for use in table
captions.</li>
<li>
<code>point</code> is the function to calculate the point estimate
(called as <code>point(x)</code>, and it must return a scalar).</li>
<li>
<code>spread</code> is the function to calculate the spread (or
variability). The function will be called as <code>spread(x)</code> and
must return a scalar or a two-long vector.</li>
</ul>
</div>
<div class="section level2">
<h2 id="putting-it-together">Putting It Together<a class="anchor" aria-label="anchor" href="#putting-it-together"></a>
</h2>
<p>One of the most common examples is the function to calculate
C<sub>max</sub>:</p>
<pre><code><span><span class="co">#' Determine maximum observed PK concentration</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @inheritParams assert_conc_time</span></span>
<span><span class="co">#' @param check Run \code{\link{assert_conc_time}}?</span></span>
<span><span class="co">#' @return a number for the maximum concentration or NA if all</span></span>
<span><span class="co">#' concentrations are missing</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">pk.calc.cmax</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">conc</span>, <span class="va">check</span><span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">check</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="../reference/assert_conc_time.html">assert_conc_time</a></span><span class="op">(</span>conc<span class="op">=</span><span class="va">conc</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">conc</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">conc</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="cn">NA</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">conc</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="co">## Add the column to the interval specification</span></span>
<span><span class="fu"><a href="../reference/add.interval.col.html">add.interval.col</a></span><span class="op">(</span><span class="st">"cmax"</span>,</span>
<span>                 FUN<span class="op">=</span><span class="st">"pk.calc.cmax"</span>,</span>
<span>                 values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                 unit_type<span class="op">=</span><span class="st">"conc"</span>,</span>
<span>                 pretty_name<span class="op">=</span><span class="st">"Cmax"</span>,</span>
<span>                 desc<span class="op">=</span><span class="st">"Maximum observed concentration"</span>,</span>
<span>                 depends<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/PKNCA.set.summary.html">PKNCA.set.summary</a></span><span class="op">(</span><span class="st">"cmax"</span>, <span class="st">"geometric mean and geometric coefficient of variation"</span>, <span class="va">business.geomean</span>, <span class="va">business.geocv</span><span class="op">)</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Bill Denney, Clare Buckeridge.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
